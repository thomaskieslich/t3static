#!/bin/bash
set -euo pipefail

# Get script directory reliably
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/includes/run-common.sh"

loadEnv "${SCRIPT_DIR}"

# Handle --rebuild option
if [[ $# -gt 0 && "$1" == "--rebuild" ]]; then
    echo "Remove Tools and rebuild..."

    # Remove vendor directory with better error handling
    if [ -d "${TEST_PATH}/vendor" ]; then
        echo "Removing ${TEST_PATH}/vendor..."
        rm -rf "${TEST_PATH}/vendor" 2>/dev/null || {
            echo "Warning: Could not remove vendor directory, trying with sudo..."
            sudo rm -rf "${TEST_PATH}/vendor" || {
                echo "ERROR: Failed to remove vendor directory. Please remove manually."
                exit 1
            }
        }
    fi

    # Remove node_modules directory with better error handling
    if [ -d "${TEST_PATH}/node_modules" ]; then
        echo "Removing ${TEST_PATH}/node_modules..."
        rm -rf "${TEST_PATH}/node_modules" 2>/dev/null || {
            echo "Warning: Could not remove node_modules directory, trying with sudo..."
            sudo rm -rf "${TEST_PATH}/node_modules" || {
                echo "ERROR: Failed to remove node_modules directory. Please remove manually."
                exit 1
            }
        }
    fi
fi

checkPackages() {
    installRequired=false

    # Check for required commands
    if ! command -v composer &>/dev/null; then
        echo "ERROR: composer is not installed"
        exit 1
    fi
    if ! command -v npm &>/dev/null; then
        echo "ERROR: npm is not installed"
        exit 1
    fi

    # Check and install composer dependencies
    if [ ! -d "${TEST_PATH}/vendor" ]; then
        installRequired=true
    fi

    if [ ! -f "${TEST_PATH}/vendor/autoload.php" ]; then
        installRequired=true
    fi

    # Check and install npm dependencies
    if [ ! -d "${TEST_PATH}/node_modules" ]; then
        installRequired=true
    fi

    if [ ! -f "${TEST_PATH}/node_modules/.package-lock.json" ]; then
        installRequired=true
    fi

    # Install packages if required
    if [ "$installRequired" = true ]; then
        installPackages
    fi
}

installPackages() {
    # Install composer packages
    echo "Installing composer packages..."
    rm -rf "${TEST_PATH}/composer.lock"
    composer install --no-progress --no-interaction --working-dir="${TEST_PATH}"

    # Check and install npm dependencies
    echo "Installing npm packages..."
    rm -rf "${TEST_PATH}/package-lock.json"
    npm install --loglevel=error --prefix="${TEST_PATH}"
}

checkPackages

# Validate t3static exists and is executable
if [ ! -x "${SCRIPT_DIR}/includes/base.sh" ]; then
    echo "ERROR: t3static not found or not executable at ${SCRIPT_DIR}/includes/base.sh"
    exit 1
fi

# Run t3static with all passed arguments
exec "${SCRIPT_DIR}/includes/base.sh" "$@"
exit $?
